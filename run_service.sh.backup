#!/bin/bash
# Saju Engine Service Runner for WSL/Linux
# Usage: ./run_service.sh <service-name> [port]

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check arguments
if [ $# -lt 1 ]; then
    echo -e "${RED}Error: Service name required${NC}"
    echo "Usage: $0 <service-name> [port]"
    echo ""
    echo "Available services:"
    echo "  - api-gateway (default port: 8000)"
    echo "  - analysis-service (default port: 8001)"
    echo "  - astro-service (default port: 8002)"
    echo "  - pillars-service (default port: 8003)"
    echo "  - tz-time-service (default port: 8004)"
    echo "  - llm-checker (default port: 8005)"
    echo "  - llm-polish (default port: 8006)"
    echo "  - all (runs all services)"
    exit 1
fi

SERVICE=$1
PORT=${2:-""}

# Activate virtual environment if not already activated
if [ -z "$VIRTUAL_ENV" ]; then
    echo -e "${YELLOW}Activating virtual environment...${NC}"
    if [ -f "venv/bin/activate" ]; then
        source venv/bin/activate
    else
        echo -e "${RED}Error: Virtual environment not found. Run setup_env.sh first.${NC}"
        exit 1
    fi
fi

# Set PYTHONPATH
export PYTHONPATH="${PYTHONPATH}:$(pwd)"

# Load local environment if exists
if [ -f ".env.local" ]; then
    export $(cat .env.local | grep -v '^#' | xargs)
fi

# Function to run a single service
run_single_service() {
    local service_name=$1
    local service_port=$2
    local service_path="services/${service_name}/app/main.py"

    if [ ! -f "$service_path" ]; then
        echo -e "${RED}Error: Service ${service_name} not found at ${service_path}${NC}"
        return 1
    fi

    echo -e "${GREEN}Starting ${service_name} on port ${service_port}...${NC}"
    echo -e "${BLUE}URL: http://localhost:${service_port}${NC}"
    echo -e "${BLUE}Docs: http://localhost:${service_port}/docs${NC}"
    echo ""

    uvicorn "services.${service_name//-/_}.app.main:app" \
        --host 0.0.0.0 \
        --port "${service_port}" \
        --reload \
        --log-level info
}

# Run all services in tmux or screen
run_all_services() {
    echo -e "${YELLOW}Starting all services...${NC}"

    # Check if tmux is available
    if command -v tmux &> /dev/null; then
        echo -e "${GREEN}Using tmux to run services${NC}"

        # Create new tmux session
        tmux new-session -d -s saju-engine

        # Start each service in a new window
        tmux new-window -t saju-engine -n api-gateway "source venv/bin/activate && ./run_service.sh api-gateway 8000"
        tmux new-window -t saju-engine -n analysis "source venv/bin/activate && ./run_service.sh analysis-service 8001"
        tmux new-window -t saju-engine -n astro "source venv/bin/activate && ./run_service.sh astro-service 8002"
        tmux new-window -t saju-engine -n pillars "source venv/bin/activate && ./run_service.sh pillars-service 8003"
        tmux new-window -t saju-engine -n tz-time "source venv/bin/activate && ./run_service.sh tz-time-service 8004"

        echo -e "${GREEN}All services started in tmux session 'saju-engine'${NC}"
        echo "To attach: tmux attach-session -t saju-engine"
        echo "To list windows: tmux list-windows -t saju-engine"
    else
        echo -e "${RED}tmux not found. Please install tmux for multi-service support${NC}"
        echo "Install with: sudo apt install tmux"
        exit 1
    fi
}

# Determine port based on service
if [ -z "$PORT" ]; then
    case $SERVICE in
        api-gateway)
            PORT=8000
            ;;
        analysis-service)
            PORT=8001
            ;;
        astro-service)
            PORT=8002
            ;;
        pillars-service)
            PORT=8003
            ;;
        tz-time-service)
            PORT=8004
            ;;
        llm-checker)
            PORT=8005
            ;;
        llm-polish)
            PORT=8006
            ;;
        all)
            run_all_services
            exit 0
            ;;
        *)
            echo -e "${RED}Unknown service: $SERVICE${NC}"
            exit 1
            ;;
    esac
fi

# Run the service
run_single_service "$SERVICE" "$PORT"