#!/bin/bash
# Saju Engine Setup Test Script
# Validates that the environment is properly configured

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo "üîç Saju Engine Setup Validation"
echo "================================"

ERRORS=0
WARNINGS=0

# Function to check status
check_status() {
    if [ $1 -eq 0 ]; then
        echo -e "${GREEN}‚úì${NC} $2"
        return 0
    else
        echo -e "${RED}‚úó${NC} $2"
        ERRORS=$((ERRORS + 1))
        return 1
    fi
}

warn_status() {
    echo -e "${YELLOW}‚ö†${NC} $1"
    WARNINGS=$((WARNINGS + 1))
}

# Check Python version
echo -e "\n${BLUE}Checking Python Installation...${NC}"
if python3.11 --version &> /dev/null; then
    VERSION=$(python3.11 --version)
    check_status 0 "Python 3.11 found: $VERSION"
else
    check_status 1 "Python 3.11 not found"
fi

# Check virtual environment
echo -e "\n${BLUE}Checking Virtual Environment...${NC}"
if [ -d "venv" ]; then
    check_status 0 "Virtual environment directory exists"
    if [ -f "venv/bin/activate" ]; then
        check_status 0 "Activation script found"
    else
        check_status 1 "Activation script not found"
    fi
else
    check_status 1 "Virtual environment not found"
fi

# Activate virtual environment
if [ -f "venv/bin/activate" ]; then
    source venv/bin/activate
    check_status 0 "Virtual environment activated"
else
    warn_status "Cannot activate virtual environment"
fi

# Check required Python packages
echo -e "\n${BLUE}Checking Python Packages...${NC}"
PACKAGES=(
    "fastapi"
    "uvicorn"
    "httpx"
    "pytest"
    "black"
    "ruff"
    "mypy"
)

for pkg in "${PACKAGES[@]}"; do
    if python -c "import $pkg" 2>/dev/null; then
        check_status 0 "$pkg installed"
    else
        check_status 1 "$pkg not installed"
    fi
done

# Check services structure
echo -e "\n${BLUE}Checking Services Structure...${NC}"
SERVICES=(
    "api-gateway"
    "analysis-service"
    "astro-service"
    "pillars-service"
    "tz-time-service"
    "llm-checker"
    "llm-polish"
)

for service in "${SERVICES[@]}"; do
    if [ -f "services/$service/app/main.py" ]; then
        check_status 0 "$service found"
    else
        check_status 1 "$service not found"
    fi
done

# Check common module
echo -e "\n${BLUE}Checking Common Module...${NC}"
if [ -f "services/common/__init__.py" ]; then
    if python -c "from services.common import create_service_app" 2>/dev/null; then
        check_status 0 "Common module importable"
    else
        check_status 1 "Common module not importable"
    fi
else
    check_status 1 "Common module not found"
fi

# Check data files
echo -e "\n${BLUE}Checking Data Files...${NC}"
if [ -d "data/sample" ]; then
    check_status 0 "Sample data directory exists"
    if [ -f "data/sample/terms_1992.csv" ]; then
        check_status 0 "Sample CSV data found"
    else
        warn_status "Sample CSV data not found"
    fi
else
    check_status 1 "Sample data directory not found"
fi

# Check file permissions
echo -e "\n${BLUE}Checking File Permissions...${NC}"
if [ -x "setup_env.sh" ]; then
    check_status 0 "setup_env.sh is executable"
else
    warn_status "setup_env.sh is not executable"
fi

if [ -x "run_service.sh" ]; then
    check_status 0 "run_service.sh is executable"
else
    warn_status "run_service.sh is not executable"
fi

# Test import of a service
echo -e "\n${BLUE}Testing Service Imports...${NC}"
if python -c "from services.analysis_service.app.main import app" 2>/dev/null; then
    check_status 0 "Analysis service importable"
else
    check_status 1 "Analysis service import failed"
fi

# Run pytest on a simple test
echo -e "\n${BLUE}Running Sample Tests...${NC}"
if pytest services/api-gateway/tests/test_health.py -v 2>/dev/null; then
    check_status 0 "Sample test passed"
else
    warn_status "Sample test failed or pytest not configured"
fi

# Summary
echo -e "\n================================"
echo -e "${BLUE}Validation Summary:${NC}"
echo -e "Errors: ${ERRORS}"
echo -e "Warnings: ${WARNINGS}"

if [ $ERRORS -eq 0 ]; then
    if [ $WARNINGS -eq 0 ]; then
        echo -e "${GREEN}‚úÖ All checks passed! Environment is ready.${NC}"
    else
        echo -e "${YELLOW}‚ö†Ô∏è Setup complete with warnings. Review above for details.${NC}"
    fi
    echo ""
    echo "Next steps:"
    echo "1. Run a service: ./run_service.sh api-gateway"
    echo "2. Run tests: pytest"
    echo "3. Check service health: curl http://localhost:8000/health"
    exit 0
else
    echo -e "${RED}‚ùå Setup validation failed. Please fix errors above.${NC}"
    echo ""
    echo "To fix:"
    echo "1. Run: ./setup_env.sh"
    echo "2. Then run this test again: ./test_setup.sh"
    exit 1
fi